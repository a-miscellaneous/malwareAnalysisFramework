import optuna
import json


def parse(name, best):
    norm = True if name.split("_")[-1] == "norm" else False
    embedding = name.split("/")[-1].split("_study")[0]
    model = name.split("_")[1]
    return {"embedding": embedding, "model": model, "norm": norm, "value": best.values[0], "params": best.params}


def get_optuna_study_info(database_url):
    # Open the Optuna storage using the specified database URL

    studySums = optuna.study.get_all_study_summaries(
        storage=database_url)

    study_info = []

    for study in studySums:
        if study.best_trial is not None:

            study_info.append(parse(study.study_name, study.best_trial))

    return study_info

def run(dbPath, outPath):
    study_info = get_optuna_study_info(dbPath)
    with open(outPath, 'w') as file:
        json.dump(study_info, file)
        
    for x in study_info:
        print(x)

if __name__ == '__main__':
    # Replace 'sqlite:///db.sqlite3' with your database URL
    database_url = 'sqlite:///db.sqlite3'

    study_info = get_optuna_study_info(database_url)
    with open('studies.json', 'w') as file:
        json.dump(study_info, file)
    # Print or return the dictionary with study information
    for x in study_info:
        print(x)
